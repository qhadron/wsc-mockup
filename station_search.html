<!DOCTYPE html>
<!--[if lt IE 9]><html class="no-js lt-ie9" lang="en" dir="ltr"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en" dir="ltr">
	<!--<![endif]-->

	<head>
		<meta charset="utf-8">
		<!-- Web Experience Toolkit (WET) / Boîte à outils de l'expérience Web (BOEW)
		wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html -->
		<title>Station Update - HYDEX Update
		</title>
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<!-- Meta data -->
		<meta name="description" content="Web Experience Toolkit (WET) includes reusable components for building and maintaining innovative Web sites that are accessible, usable, and interoperable. These reusable components are open source software and free for use by departments and external Web communities">
		<meta name="dcterms.title" content="Information to update:">
		<meta name="dcterms.creator" content="French name of the content author / Nom en français de l'auteur du contenu">
		<meta name="dcterms.issued" title="W3CDTF" content="Date published (YYYY-MM-DD) / Date de publication (AAAA-MM-JJ)">
		<meta name="dcterms.modified" title="W3CDTF" content="Date modified (YYYY-MM-DD) / Date de modification (AAAA-MM-JJ)">
		<meta name="dcterms.subject" title="scheme" content="French subject terms / Termes de sujet en français">
		<meta name="dcterms.language" title="ISO639-2" content="eng">
		<!-- Meta data-->
		<!--[if gte IE 9 | !IE ]><!-->
		<link href="./theme-gc-intranet/assets/favicon.ico" rel="icon" type="image/x-icon">
		<link rel="stylesheet" href="theme-gc-intranet/css/theme.css">
		<!--<![endif]-->
		<!--[if lt IE 9]>
		<link href="./theme-gc-intranet/assets/favicon.ico" rel="shortcut icon" />
		<link rel="stylesheet" href="./theme-gc-intranet/css/ie8-theme.min.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="./wet-boew/js/ie8-wet-boew.min.js"></script>
		<![endif]-->
		<noscript><link rel="stylesheet" href="./wet-boew/css/noscript.min.css" /></noscript>
	</head>

	<body vocab="http://schema.org/" typeof="WebPage">
		<ul id="wb-tphp">
			<li class="wb-slc">
				<a class="wb-sl" href="#wb-cont">Skip to main content</a>
			</li>
			<li class="wb-slc visible-sm visible-md visible-lg">
				<a class="wb-sl" href="#wb-info">Skip to "About this site"</a>
			</li>
			<li class="wb-slc visible-md visible-lg">
				<a class="wb-sl" href="#wb-sec">Skip to section menu</a>
			</li>
		</ul>
		<header role="banner">
			<div id="wb-bnr">
				<div id="wb-bar">
					<div class="container">
						<div class="row">
							<object id="gcwu-sig" type="image/svg+xml" tabindex="-1" role="img" data="./theme-gc-intranet/assets/sig-blk-en.svg" aria-label="Government of Canada"></object>
							<section id="wb-lng">
								<h2>Language selection</h2>
								<ul class="list-inline">
									<li><a lang="fr" href="content-secmenu-fr.html">Français</a></li>
								</ul>
							</section>
							<section class="wb-mb-links col-xs-12 visible-sm visible-xs" id="wb-glb-mn">
								<h2>Search and menus</h2>
								<ul class="pnl-btn list-inline text-right">
									<li><a href="#mb-pnl" title="Search and menus" aria-controls="mb-pnl" class="overlay-lnk btn btn-sm btn-default" role="button"><span class="glyphicon glyphicon-search"><span class="glyphicon glyphicon-th-list"><span class="wb-inv">Search and menus</span></span></span></a></li>
								</ul>
								<div id="mb-pnl"></div>
							</section>
						</div>
					</div>
				</div>
				<div class="container">
					<div class="row">
						<div id="wb-sttl" class="col-md-12">
							<a href="http://wet-boew.github.io/v4.0-ci/index-en.html">
								<span>Water Survey of Canada HYDEX data update</span>
							</a>
							<object id="wmms" type="image/svg+xml" tabindex="-1" role="img" data="./theme-gc-intranet/assets/wmms-intra.svg" aria-label="Symbol of the Government of Canada"></object>
						</div>
					</div>
				</div>
			</div>
			<nav role="navigation" id="wb-sm" data-ajax-replace="./ajax/sitemenu-loggedout.html" data-trgt="mb-pnl" class="wb-menu visible-md visible-lg" typeof="SiteNavigationElement">
				<div class="container nvbar">
					<h2>Topics menu</h2>
					<div class="row">
						<ul class="list-inline menu">
							<li><a href="./index-en.html">HYDEX Reports</a></li>
							<li><a href="./docs/start-en.html#implement">HYDEX  update</a></li>
							<li><a href="./docs/start-en.html">HYDEX Administration</a></li>
						</ul>
					</div>
				</div>
			</nav>
			<nav role="navigation" id="wb-bc" property="breadcrumb">
				<h2>You are here:</h2>
				<div class="container">
					<div class="row">
						<ol class="breadcrumb">
							<li>
								<a href="index.html">HYDEX Home</a>
							</li>
							<li>
								Station Update
							</li>
						</ol>
					</div>
				</div>
			</nav>
		</header>
		<div data-ajax-replace="ajax/login-info.html"></div>
		<main role="main" property="mainContentOfPage" class="container">
			<h1 id="wb-cont">Update station information</h1>
			<!-- Page content -->

			<div class="row mrgn-bttm-md">
				<div class="col-lg-12">
					<p></p>
					<div class="wb-frmvld">
						<div class="wb-tabs">
							<div class="tabpanels">
								<script type="text/javascript">
									/*global radioButtonSelect*/
									radioButtonSelect = function (id) {
										let elem = document.getElementById(id);
										elem.checked = true;
									};
								</script>
								<details id="station_search" style="animation: none">
									<summary>Search for Station</summary>
									<form id="search-form" method="get">
										<div class="form-group">
											<input type="radio" id="station-name-search" name="search_type" value="station_name" checked>
											<label for="station-name">Station Name</label>
											<input type="text" id="station-name" name="station_name" class="form-control" placeholder="Enter Station Name" maxlength="100" pattern="^[A-Za-z0-9 ()/;ÀàÉéÈèÎî,.#-]{1,100}$" onfocus="radioButtonSelect('station-name-search')">
										</div>
										<div class="form-group">
											<input type="radio" id="station-number-search" name="search_type" value="station_number" />
											<label for="station-number">Station Number</label>
											<input type="text" id="station-number" name="station_number" class="form-control" placeholder="Enter Station Number" maxlength="159" pattern="^([A-Za-z0-9]{1,7}|(\d{2}([A-Za-z]{2}\d{3}|[A-Za-z]{3}\d{2}))(,\d{2}([A-Za-z]{2}\d{3}|[A-Za-z]{3}\d{2})){1,19})$"
												onfocus="radioButtonSelect('station-number-search');" list="suggestions" />
											<datalist id="suggestions">
											<option value="123456789" label="123456789"></option>
											<option value="99ZZ204" label="99ZZ204"></option>
											<option value="99ZZ013" label="99ZZ013"></option>
										</datalist>
										</div>
										<input type="button" value="Search for stations" class="btn btn-primary mrgn-bttm-md" onclick="document.location.href='station_search_results.html'">
									</form>
								</details>
								<details id="mystations" style="animation: none">
									<summary>My Stations</summary>
									<div>
										<table class="wb-tables table table-striped" data-ajax-replace='ajax/station-list-body.html'>
										</table>
									</div>
								</details>
								<details style="animation: none">
									<summary>Create Station</summary>
									<div style="overflow: hidden">
										<form action="javascript:alert('Redirects to a page with some mandatory update sections.');" class="form-horizontal" novalidate>
											<div class="form-group">
												<label class="col-sm-4 control-label required">New ID:</label>
												<div class="col-sm-8">
													<input type="text" class="form-control" pattern="^\d{2}[a-zA-Z]{2}[a-zA-Z0-9]{1}\d{2}$" placeholder="###AA### or ###AAA##" style="display: inline-block;" title="Format is 3 digits followed by two letters followed by a letter or a digit followed by two digits">
													<label style="display: inline-block; padding-left: 1em;">(ex: 99ZZ012 or 99ZZG03)</label>
												</div>
											</div>
											<div class="form-group" effective-date="effective-date"></div>
											<div class="form-group" data-ajax-replace="ajax/submit-button.html"></div>
										</form>
									</div>
								</details>
								<details style="animation: none">
									<summary>Assign Stations</summary>
									<div style="overflow-x: hidden">
										<form action="#" class="form-horizontal" id="station-assign-form">
											<div class="panel panel-default">
												<header class="panel-heading">
													<h6 class="panel-title">Add Stations</h6>
												</header>
												<div class="panel-body">
													<div class="form-group">
														<label class="control-label col-sm-4">Station Id</label>
														<input type="text" class="form-control col-sm-8">
														<span class="input-group-btn" style="display: inline;">
															<button class="btn input-sm btn-primary add-station-button" style="margin-left: -1px;border-bottom-left-radius: 0; border-top-left-radius: 0;" disabled>Add</button>
														</span>
														<span class="output" style="padding-left: 3em"></span>
													</div>
													<div class="form-group">
														<label class="control-label col-sm-4">Stations Belonging to Tech</label>
														<select class="form-control col-sm-8">
															<option>NOT ASSIGNED</option>
															<option>OTTAWA ADMINS</option>
															<option>USERNAME LASTNAME</option>
														</select>
														<span class="input-group-btn" style="display: inline">
															<button class="btn input-sm btn-primary add-user-station-button" style="margin-left: -1px;border-bottom-left-radius: 0; border-top-left-radius: 0;">Add</button>
														</span>
														<section class="mfp-hide modal-dialog modal-content overlay-def" style="width: auto">
															<header class="modal-header">
																<h2 class="modal-title"></h2>
															</header>
															<div class="modal-body">
																<div class="container"></div>
															</div>
															<div class="modal-footer">
																<div class="form-group" style="justify-content: center; display: flex">
																	<button class="form-control btn btn-primary popup-modal-dismiss">Add Stations</button>
																	<button class="form-control btn btn-default popup-modal-dismiss">Cancel</button>
																</div>
															</div>
														</section>
													</div>
												</div>
											</div>
											<details open="" class="station-selection-container">
												<summary>
													<h2>Selected Stations</h2>
												</summary>
												<div>
													<button class="btn btn-danger pull-right">
														Remove Selected Stations
													</button>
												</div>
											</details>
											<div class="form-group">
												<label class="col-sm-4 control-label">
													Assign to
												</label>
												<div class="col-sm-8">
													<select class="form-control">
														<option>NOT ASSIGNED</option>
														<option>OTTAWA ADMINS</option>
														<option>USERNAME LASTNAME</option>
													</select>
												</div>
											</div>
											<div class="form-group" effective-date></div>

											<template id="station-table">
												<table class="table table-hover station-table">
													<thead>
														<th></th>
														<th>Station Number</th>
														<th>Station Name</th>
														<th>Effective Date</th>
														<th></th>
													</thead>
													<tbody></tbody>
												</table>
											</template>
											<template id="station-table-row">
												<tr>
													<td><input type="checkbox" class="form-control"></td>	
													<td class="slot id"></td> 
													<td class="slot name"></td>
													<td class="slot date"></td>
													<td>
														<button class="form-control btn btn-danger" onclick="this.parentElement.parentElement.remove(); return false;">
															<span class="glyphicon glyphicon-trash"></span>
														</button>
													</td>	
												</tr>
											</template>
											<style type="text/css">
												.station-table.add tr.selected {
													background-color: #dff0d8;
												}
												
												.station-table.remove tr.selected {
													background-color: #f2dede;
												}
												
												tr.empty {
													background-color: #f5f5f5;
													text-align: center;
												}
											</style>

											<div data-ajax-replace="ajax/submit-button.html"></div>
										</form>

										<script type="text/javascript">
											$(document).on('wb-ready.wb-tabs', () => {
												(async function () {
													'use strict';

													function prepareStationData(src) {
														const propName = 'date';
														let data = src.slice();
														for (let info of data) {
															if (!info[propName]) {
																info[propName] = randDate();
															}
														}
														data.sort((a, b) => a.id > b.id ? 1 : a.id === b.id ? 0 : -1);
														data.forEach(x => x[propName] = x[propName].toISOString().slice(0, 10));
														return data;
													}

													const makeRow = function (data, options = {
														deletable: false
													}) {
														const {
															deletable
														} = options;
														const rowTmpl = this.rowTmpl = this.rowTmpl || document.getElementById('station-table-row');

														// initialize template
														this.first = typeof this.first === "undefined";
														if (this.first) {
															for (let slot of rowTmpl.content.querySelectorAll('.slot')) {
																slot.style.verticalAlign = 'middle';
															}
														}

														for (let key in data) {
															rowTmpl.content.querySelector(`.slot.${key}`).textContent = data[key];
														}
														let clone = document.importNode(rowTmpl.content, true);
														if (!deletable) {
															clone.querySelector('button').parentElement.remove();
														}
														return clone;
													}.bind({});

													function addStationRowToTable(table, data, options) {
														let row;
														if (!data) {
															row = document.createElement('tr');
															row.classList.add('empty');
															row.innerHTML = `<td colspan="${table.querySelector('thead > tr').childElementCount}">No Stations Selected</td>`;
														}
														else {
															// search table for existing data
															let existing = new Set(
																Array.from(table.querySelectorAll('.slot.id'))
																.map(elem => elem.textContent.toUpperCase())
															);

															if (existing.has(data.id)) {
																return null;
															}

															data = prepareStationData([Object.assign({}, data)])[0];

															row = makeRow(data, options);
															Array.from(table.querySelector('tbody').querySelectorAll('tr.empty'))
																.forEach(x => x.remove());
														}
														return table.querySelector('tbody').appendChild(row);
													}

													const makeStationSelectTable = function (data, options = {
														deletable: false
													}) {
														const {
															deletable
														} = options;
														const tableTmpl = this.tableTmpl = this.tableTmpl || document.getElementById('station-table');
														const table = document.importNode(tableTmpl.content, true).querySelector('table');
														const tbody = table.querySelector('tbody');

														this.rowClicked = this.rowClicked || function (e) {}
														tbody.addEventListener('click', evt => {
															//find the row of the clicked element
															let row = evt.target;
															while (row && row.tagName !== "TR")
																row = row.parentElement;
															// some random place has been clicked, ignore...
															if (!row) {
																return;
															}
															// auto click checkbox
															if (evt.target.tagName !== "INPUT") {
																let checkbox = row.querySelector('input[type="checkbox"]');
																if (checkbox && checkbox != evt.target) {
																	checkbox.dispatchEvent(new evt.constructor(evt.type, evt));
																}
															}
															// checkbox clicked, add style to row
															else {
																row.classList.toggle('selected');
															}

														});

														for (let info of data) {
															tbody.appendChild(makeRow(info, options));
														}

														return table;
													}.bind({});

													const getStationData = (async function () {
														if (this.station_data) {
															return this.station_data.map(x => Object.assign({}, x));
														}
														else {
															return fetch('ajax/station-data.json').then(r => r.text()).then(text => JSON.parse(text))
																.then(data => {
																	this.station_data = data;
																	return getStationData();
																});
														}
													}).bind({});
													const form = document.querySelector('#station-assign-form');

													let stationListTable;
													// Station List Table
													{
														const container = form.querySelector('.station-selection-container');


														const table = makeStationSelectTable([], {
															deletable: true
														});

														// set up table
														{
															table.classList.add('remove')
															addStationRowToTable(table);
															container.appendChild(table);
															stationListTable = table;
														}

														// remove selected stations button
														{
															const button = container.querySelector('button');
															button.addEventListener('click', evt => {
																evt.preventDefault();
																Array.from(table.querySelectorAll('tr'))
																	.filter(row => {
																		let checkbox = row.querySelector('input[type="checkbox"]');
																		return checkbox && checkbox.checked;
																	})
																	.forEach(row => row.remove());
															})
														}
													};

													// Station id
													{
														const addStationButton = form.querySelector('.add-station-button');
														const addStationInput = addStationButton.parentElement.parentElement.querySelector('input[type="text"]');
														const addStationProgress = addStationButton.parentElement.parentElement.querySelector('.output');

														function setErrorMsg(msg) {
															addStationProgress.innerHTML = `<span style='color: red'>${msg}</span>`;
														}

														async function getStationDataFromInput() {
															const value = addStationInput.value;
															let resolved = false;
															let station_data = getStationData();
															let found;
															// only show loading message after 200ms
															waitabit(200).then(_ => {
																if (!resolved)
																	addStationProgress.textContent = "Checking station id...";
															});
															station_data = await station_data;
															found = station_data.find(e => e.id === value.trim().toUpperCase());
															resolved = true;
															if (!found) {
																setErrorMsg("Invalid station id!");
															}
															else {
																addStationProgress.textContent = "";
															}
															return found;
														}

														addStationInput.addEventListener('input', evt => {
															(async function () {
																addStationButton.disabled = !await getStationDataFromInput();
															})();
														});

														addStationButton.addEventListener('click', evt => {
															evt.preventDefault();
															evt.stopPropagation();
															(async function () {
																const data = await getStationDataFromInput();
																let ret = addStationRowToTable(stationListTable, data, {
																	deletable: true
																});
																if (!ret) {
																	setErrorMsg("Station already added!");
																}
															})();
															return false;
														});
													}

													// Station belonging to tech
													{
														const triggerButton = form.querySelector('.add-user-station-button');
														const root = triggerButton.parentElement.parentElement;
														const popup = root.querySelector('.modal-dialog');

														let stationTable;
														// open modal title
														{
															const select = root.querySelector('select');
															const title = popup.querySelector('.modal-title');
															const container = popup.querySelector('.container');
															triggerButton.addEventListener('click', e => {
																e.preventDefault();
																e.stopPropagation();
																title.textContent = `Loading ${select.value} stations failed...`;

																(async function () {
																	let data = getStationData();
																	while (container.hasChildNodes())
																		container.removeChild(container.firstChild);

																	// aim for 10 entries
																	{
																		let lastChar = select.value.charCodeAt(select.value.length - 1);
																		data = (await data).filter(x => x.name.charCodeAt(x.id.length - 1) % 10 === lastChar % 10).filter(x => Math.random() < .05).splice(0, lastChar % 10);
																	}

																	data = prepareStationData(data);
																	stationTable = makeStationSelectTable(data);
																	stationTable.classList.add('add');

																	container.appendChild(stationTable);
																	title.textContent = `${select.value} stations`;

																	$(document).trigger('open.wb-lbx', [
															[
																			{
																				src: $(popup),
																				type: "inline",
																}
															]
														]);
																})();

																return false;
															});
														}

														// add stations to main table
														{
															const addButton = popup.querySelector('button.btn-primary');
															addButton.addEventListener('click', evt => {
																(async function () {
																	let stationdata = getStationData();
																	const ids =
																		new Set(Array.from(stationTable.querySelectorAll('tr'))
																			.filter(row => {
																				let checkbox = row.querySelector('input[type="checkbox"]');
																				return checkbox && checkbox.checked;
																			})
																			.map(row => row.querySelector('.slot.id').textContent));
																	stationdata = await stationdata;

																	stationdata
																		.filter(info => ids.has(info.id))
																		.forEach(info => addStationRowToTable(stationListTable, info, {
																			deletable: true
																		}));
																})();
															});
														}
													}

												})();
											});
										</script>
									</div>
								</details>
							</div>
						</div>
					</div>
				</div>
			</div>

			<dl id="wb-dtmd">
				<dt>Date modified:&#32;</dt>
				<dd><time property="dateModified">2017-06-16</time></dd>
			</dl>
		</main>
		<footer role="contentinfo" id="wb-info" class="visible-sm visible-md visible-lg wb-navcurr" data-ajax-replace="ajax/footer.html">
		</footer>
		<!--[if gte IE 9 | !IE ]><!-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
		<script src="./wet-boew/js/wet-boew.min.js"></script>
		<script type="text/javascript" src="custom-elems.js"></script>
		<!--<![endif]-->
		<!--[if lt IE 9]>
		<script src="./wet-boew/js/ie8-wet-boew2.min.js"></script>

		<![endif]-->
	</body>

</html>
